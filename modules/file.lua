luagimp.file = {
    helpstring = "luagimp.file: luagimp File module is the main module of file system. Using it, you can create files, load them, save, export etc.",
    variables = {
        files = {},
        file_templates = {
            none = {
                width = 100,
                height = 100,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            a0 = {
                width = 840.99,
                height = 1188.97,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            a1 = {
                width = 594.02,
                height = 840.99,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            a2 = {
                width = 419.95,
                height = 594.02,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            a3 = {
                width = 297.01,
                height = 419.95,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            a4 = {
                width = 209.97,
                height = 297.01,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            a5 = {
                width = 148,
                height = 209.97,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            a6 = {
                width = 104.99,
                height = 148,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            a7 = {
                width = 74,
                height = 104.99,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            b4 = {
                width = 250.02,
                height = 352.98,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            b5 = {
                width = 176.02,
                height = 250.02,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["b5-japan"] = {
                width = 182.03,
                height = 256.96,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["us-letter"] = {
                width = 8.500,
                height = 11,
                unit = "in",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["us-legal"] = {
                width = 8.500,
                height = 14,
                unit = "in",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["88.9x50.8-us-business-card"] = {
                width = 88.9,
                height = 50.8,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["85x55-western-europe-business-card"] = {
                width = 85.01,
                height = 55.03,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["90x50-eastern-europe-business-card"] = {
                width = 90,
                height = 50.04,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["90x55-business-card"] = {
                width = 90,
                height = 55.03,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["87x49-vistaprint-business-card"] = {
                width = 87.04,
                height = 49.02,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["toilet-paper"] = {
                width = 4.5,
                height = 4.5,
                unit = "in",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["cd-cover"] = {
                width = 120.99,
                height = 119.97,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 300,
                y_resolution = 300,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["web-banner-leaderboard-728x90"] = {
                width = 728,
                height = 90,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["web-banner-large-rectangle-336x280"] = {
                width = 336,
                height = 280,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["web-banner-medium-rectandle-300x250"] = {
                width = 300,
                height = 250,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["web-banner-large-mobile-320x100"] = {
                width = 320,
                height = 100,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["web-banner-large-skyscraper-300x600"] = {
                width = 300,
                height = 600,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["1280x720-hd-720p"] = {
                width = 1280,
                height = 720,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["1920x1080-full-hd-1080p"] = {
                width = 1280,
                height = 720,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["3840x2160-4k-uhd"] = {
                width = 3840,
                height = 2160,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["4096-2160-digital-cinema-initiatives-4k"] = {
                width = 4096,
                height = 2160,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["1366x768-hd"] = {
                width = 1366,
                height = 768,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["1920x1200-WUXGA"] = {
                width = 1920,
                height = 1200,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["2560x1600-WQXGA"] = {
                width = 1280,
                height = 720,
                unit = "px",
                color_space = "RGB-color",
                x_resolution = 72,
                y_resolution = 72,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["apple-iphone-6/7"] = {
                width = 58.44,
                height = 103.94,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 326,
                y_resolution = 326,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["apple-iphone-5"] = {
                width = 49.87,
                height = 88.51,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 326,
                y_resolution = 326,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["apple-ipad-3&4-air"] = {
                width = 197.04,
                height = 262.85,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 264,
                y_resolution = 264,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["samsung-galaxy-s6"] = {
                width = 63.39,
                height = 112.69,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 577,
                y_resolution = 577,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["samsung-galaxy-s5"] = {
                width = 76.2,
                height = 135.47,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 360,
                y_resolution = 360,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            },
            ["samsung-galaxy-tab-2&3-10-1-inch"] = {
                width = 136.38,
                height = 218.20,
                unit = "mm",
                color_space = "RGB-color",
                x_resolution = 149,
                y_resolution = 149,
                color_manage = true,
                gamma = "sRGB",
                fill_with = "background-color"
            }
        },
        available_gamma = {
            "sRGB",
            "linear-light"
        },
        available_color_space = {
            "RGB-color",
            "grayscale"
        }
    },
    helpstrings = {
        new = "luagimp.file.new: This function allows you to create files. To use it and create file, you should use 1 argument: model. Example model:\n"..
[[
{
    template = string ("none" by default. Template pre-sets arguments),
    image_size = {
        width = number (100 by default. Defines image width),
        height = number (100 by default. Defines image height),
        unit = string ("px" by default. Defines unit used by width and height fields)
    },
    advanced_options = {
        x_resolution = number (300 by default. Defines x resolution in ppi),
        y_resolution = number (300 by default. Defines y resolution in ppi),
        color_space = string ("RGB-color" by default. Defines image color space),
        gamma = string ("sRGB" by default. Defines image gamma),
        color_manage = bool (true by default. Tells luagimp if it should color manage the image),
        fill_with = string ("background-color" by default. Defines what should the image be filled when created)
    }
}
]]
    }
}

function luagimp.file.new(model)
    local new_file = {}
    local template = model.template or "none"

    -- Image Size
    model.image_size = model.image_size or {}
    new_file.width = model.image_size.width or luagimp.file.variables.file_templates[template].width
    new_file.height = model.image_size.height or luagimp.file.variables.file_templates[template].height
    local unit = model.image_size.unit or luagimp.file.variables.file_templates[template].unit
    
    -- Advanced Options
    model.advanced_options = model.advanced_options or {}
    new_file.x_resolution = model.advanced_options.x_resolution or luagimp.file.variables.file_templates[template].x_resolution
    new_file.y_resolution = model.advanced_options.y_resolution or luagimp.file.variables.file_templates[template].y_resolution
    new_file.color_space = model.advanced_options.color_space or luagimp.file.variables.file_templates[template].color_space
    new_file.gamma = model.advanced_options.gamma or luagimp.file.variables.file_templates[template].gamma
    if model.advanced_options.color_manage == nil then
        new_file.color_manage = luagimp.file.variables.file_templates[template].color_manage
    else
        new_file.color_manage = model.advanced_options.color_manage
    end
    new_file.fill_with = model.advanced_options.fill_with or luagimp.file.variables.file_templates[template].fill_with

    -- Calculating pixel dimensions
    if not luagimp.variables.unit_formulas[unit] then
        error("luagimp-error: Unit \"" .. unit .. "\" not supported.", 2)
    elseif unit == "in" then
        new_file.width, new_file.height = new_file.width*new_file.x_resolution, new_file.height*new_file.y_resolution
    else
        new_file.width, new_file.height = new_file.width*luagimp.variables.unit_formulas[unit], new_file.height*luagimp.variables.unit_formulas[unit]
    end

    -- Errors

    if not luagimp.is_valid(new_file.color_space, luagimp.file.variables.available_color_space) then
        error("luagimp-error: Incorrect value: \"" .. new_file.color_space .. "\" for advanced_options.color_space", 2)
    end

    if not luagimp.is_valid(new_file.gamma, luagimp.file.variables.available_gamma) then
        error("luagimp-error: Incorrect value: \"" .. new_file.gamma .. "\" for advanced_options.gamma", 2)
    end

    if not luagimp.is_valid(new_file.fill_with, luagimp.variables.available_fill_with) then
        error("luagimp-error: Incorrect value: \"" .. new_file.fill_with .. "\" for advanced_options.fill_with", 2)
    end

    -- Finalizing
    new_file.layers = {}
    table.insert( luagimp.file.variables.files, new_file )
    luagimp.file.set_active_file(new_file)
    luagimp.layer.new {name="background", fill_with=new_file.fill_with}
    luagimp.layer.stack.select(1)

    -- Logging
    luagimp.log("luagimp project created. Dimensions: " .. new_file.width .. "x" .. new_file.height .. ". Template: " .. template .. ".")
end

function luagimp.file.set_active_file(file)
    if type(file) == "number" then
        luagimp.variables.active_file = luagimp.file.variables.files[file]
    else
        luagimp.variables.active_file = file
    end
end